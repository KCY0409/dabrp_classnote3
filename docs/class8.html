<!DOCTYPE html>
<html>
  <head>
    <title>(8주차)shiny를 활용한 웹앱 개발</title>
    <meta charset="utf-8">
    <meta name="author" content="박찬엽" />
    <link href="libs/remark-css/example.css" rel="stylesheet" />
    <link rel="stylesheet" href="class.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">




class: center, middle, title-slide

## 더욱 프로답게 만드는 동적 문서화 및 시각화
#### Step2. 클릭에 실시간으로 반응하는 Shiny Application 학습하기
### &lt;https://mrchypark.github.io/dabrp_classnote3/class8&gt;

#### [[pdf다운로드](https://github.com/mrchypark/dabrp_classnote3/raw/master/Materials/class8.pdf)] [[문의하기](http://pf.kakao.com/_RXANd)] [[피드백하기](https://github.com/mrchypark/dabrp_classnote3/issues/new)]
### 박찬엽

### 2017년 11월 16일
---

목차

1. 공부를 위한 자료
    - 문서
    - 예시 어플리케이션

1. shiny
    - 웹 어플리케이션 기초
    - 입출력 구조
    - 최소 동작 앱 만들기

1. shiny-ext
    - 지도를 그리는 leaflet
    - 차트에 마우스 동작을 추가하는 ggriaph
    - 네트워크 시각화의 끝판왕 visNetwork
    - 종합 대쉬보드 패키지 shinydashboard
    
---

## 참고하면 좋은 자료

- [공식 페이지의 갤러리](http://shiny.rstudio.com/gallery/)
- [공식 페이지의 튜토리얼](http://shiny.rstudio.com/tutorial/)
- [공식 페이지의 정보글](http://shiny.rstudio.com/articles/)
- [통계 분석 너머 R의 무궁무진한 활용(도서)](http://www.acornpub.co.kr/book/infinite-r)

---

## shiny

.pull-left[
[shiny][901]는 R로 웹 어플리케이션을 만들 수 있게 해주는 프레임워크입니다. shiny는 `ui`라고 불리는 화면, `server`라고 불리는 데이터 처리 및 관리, 그 안에 입출력과 `render`와 배포로 구성되어 있습니다.
]

.pull-right[
![](https://www.analyticsvidhya.com/wp-content/uploads/2016/10/shiny.png)
]

---

## 설치

패키지를 설치하는 방법은 다음과 같습니다.

```{}
## cran에서 설치
install.packages("shiny")

## github에서 설치
if (!requireNamespace("devtools"))
  install.packages("devtools")
devtools::install_packages("rstudio/shiny")
```

---

## shiny 앱 예시

shiny는 개발이 어려운 만큼 생태계 활성화를 위해 다양한 예시를 쉽게 접할 수 있게 준비되어 있습니다.


```r
library(shiny)
runExample()
```

```
## Valid examples are "01_hello", "02_text", "03_reactivity", "04_mpg", "05_sliders", "06_tabsets", "07_widgets", "08_html", "09_upload", "10_download", "11_timer"
```



위 코드는 실행해 볼 수 있는 예제를 보여줍니다. 아래처럼 실행하시면 바로 실행되는 `shiny` 앱 예제를 확인하 실 수 있습니다. [shiny github][904]에는 예제 `repo`가 있고, 활용할 수 있는 예제는 2017-11-16 기준 111개 입니다.


---

## 예시 실행

runExample() 함수로 리스트 내의 예시들을 실행해 볼 수 있습니다.

```{}
runExample("01_hello")
```

---

## 다른 앱 실행방법

웹에서 제공하는 다른 사람의 소스를 바로 실행해 볼 수 있습니다.

```{}
# 기스트의 예시 앱 실행
runGist()

# 깃헙의 예시 앱 실행
runGitHub()
```

---

## runGist()

Gist란 스크립트 파일 몇 개만 공유할 때 유용한 서비스입니다. shiny 코드의 경우도 간단하게 한 두개 파일로만으로도 작성할 수 있으므로 Gist로 공유되는 경우도 있습니다.

```{}
runGist("https://gist.github.com/mrchypark/61283120fea4e392116503703547f39d")
```


---

## runGitHub()

github의 username, repo 이름, 폴더가 있다면 폴더명을 지정해주면 경로내의 shiny 앱을 가져와 실행해 줍니다. 물론 앱내 사용하는 패키지가 없다면 설치해줘야 합니다.

```{}
if (!requireNamespace("dplyr")){
  install.packages("dplyr")
}
if (!requireNamespace("shinydashboard")){
  install.packages("shinydashboard")
}

runGitHub(repo = "shiny-examples",username = "rstudio",subdir = "086-bus-dashboard")
```

---

## 예시를 얻을 수 있는 곳

&lt;https://github.com/rstudio/shiny-examples&gt;은 공식적으로 잘된 사례를 모아 놓고 있습니다.

---
class: center, middle, title-slide

## shiny 패키지 구조

---

## shiny의 화면

`ui`라고 말하는 화면은 실제로 사용자가 보는 화면을 뜻합니다. shiny에서는 크게 `titlePanel`과 `sidebarPanel`, `mainPanal`의 세 가지로 구성되어 있습니다. 이렇게 지정함으로써 `html`에 대해 잘 몰라도 사용할 수 있게 `shiny`가 구성되어 있습니다.


.center[
![shiny-ui](https://raw.githubusercontent.com/mrchypark/data_camp_dabrp/master/images/shiny-ui.png)
]

---

## shiny의 서버

`shiny`에서의 `server`는 실제 서버가 브라우저와 통신하는 과정 전체를 간단하게 만들어주는 역할을 합니다. 화면에서 사용자가 동작하는 것에 대해서 받을 수 있는 `input`을 서버에서 데이터나 그림 조작에 사용을 하고 웹 기술이 이해할 수 있게  `render`하여 `output`으로 화면에 다시 보내주는 형태로 `shiny`가 동작합니다.

.center[
![ui_server](https://raw.githubusercontent.com/mrchypark/data_camp_dabrp/master/images/shiny-app-architecture.png)
]

---

## shiny의 입출력

`shiny`는 다른 `R` 패키지와는 다르게 강제하는 변수가 3개 있습니다. 그것은 `input`, `output`, `session` 입니다. 각각 객체로써 존재하고 이번에는 `input`과 `output`으로 데이터를 `ui`와 `server`가 교환하는 방법을 소개하겠습니다. 각각의 객체는 `*Input` 함수와 `*Output` 함수로 데이터를 입력 받아 저장합니다. `*Output` 함수는 `render*` 함수로 선언됩니다.

--

## shiny의 배포

`shiny`는 `shiny-server`를 통해서 동작합니다. `shiny-server`는 `shiny app`이 동작할 수 있는 서버를 의미합니다. 오픈소스와 기업용 솔루션이 모두 준비되어 있으며 실습에는 &lt;http://www.shinyapps.io/&gt;를 이용해 보겠습니다. 

---

class: center, middle, title-slide

## shiny의 입출력

---

## shiny의 입출력 

`shiny`는 웹 기술을 `R`로 사용할 수 있게 만드는 덕분에 `render`라는 과정이 필요합니다. 그래서 `render` 환경에서 변수들이 관리되어야 합니다. 입출력은 `input` 변수와 `output` 변수로 관리합니다. 이 두 가지는 `render` 밖에서 관리되는 변수로 다르게 취급해야 합니다. 

- `input` : 웹 페이지의 입력을 통해서 들어오는 데이터를 사용하기 위한 변수
- `output`: 웹 페이지에 R 연산 결과물을 전달하기 위해 사용하는 변수

---

### output$

`output` 변수는 `list`라고 이해하시면 좋을 것 같습니다. `list`인 `output` 변수는 `output$`뒤에 변수명을 작성함으로써 `output` 객체에 필요한 결과물을 전달합니다. 만약에 화면에 보여줘야할 것의 이름을 `sample`이라고 하면 `output$sample`에 필요한 내용을 선언하는 것으로 진행합니다.

```{}
...
output$sample &lt;- randerPlot({ ...plot()... })
...
```

위 코드는 `server`쪽 코드에서 작성합니다. 위 예시는 `plot`함수로 만들어지는 이미지를 `output$sample`에 저장하는 것을 뜻합니다. 그럼 `ui`쪽에서 이걸 어디에다 위치하게 하는지를 결정하는 함수에서 사용할 수 있습니다. 이때는 `plotOutput` 함수를 사용합니다.

---

### plotOutput

```{}
...
plotOutput("sample")
...
```
함수명이 `Output` 이고, `"`로 변수명을 감싸며, `output$` 문법을 사용하지 않고 컬럼명인 `sample`만 사용한다는 점을 주목해 주세요. `server`쪽 코드에서 `output$`에 컬럼명의 형태로 저장한 `R`의 결과물을 `ui`쪽 코드에서 `*Output` 함수에서 `"`로 감싼 글자의 형태로 컬럼명만 작성해서 사용합니다. 그럼 이제 위해서 `output$sample`에 선언할 때 사용한 `render*({})`에 대해서 알아보겠습니다. 

---

### render*({}) 

`Rmd` 때 `render`라는 과정을 거쳐서 `Rmd`를 `md`로, `md`를 `html`로 바꾸는 것을 알아봤었습니다. `shiny`에서도 같은 과정이 필요합니다. 그래서 `render*({ })`함수가 필요합니다. 예시로 보겠습니다.

```{}
...
output$sample &lt;- randerPlot({ 
                              
  plot(faithful)

})
...
```
---

`render*({ })` 함수 안에는 `plot` 함수가 `R` 문법으로 작성되어 있습니다. 그리고  `render*({ })`의 특이한 점은 `()` 안에 `{}`가 또 있다는 점입니다. 여기서는 `({ })` 안쪽은 `R`의 세계이고, 그 바깥은 웹의 세계라고 이해하겠습니다. 그래서 이런게 가능합니다.
```{}
...
output$sample &lt;- randerPlot({ 
  
  data &lt;- faithful[faithful$eruptions &gt;3, ]
  plot(data)

})
...
```

`R`의 세계 내에서 처리하는 것은 계속 사용할 수 있어서 `data` 변수에 선언한 내용을 `plot`함수가 사용할 수 있습니다. 여기서 `input$`이 활용될 때 반응형으로 작성할 수 있는 것입니다.

---

### input$

`intput$`은 `output$`과 같이 웹의 세계에 있는 변수입니다. 그래서 `*Input()` 함수들을 통해서 `input$`의 컬럼 이름으로 웹 페이지 내에서 얻을 수 있는 데이터를 `R`의 세계에서 사용할 수 있게 해줍니다. 우선 `input$`에 웹의 세계의 데이터를 `R`의 세계로 가져와 보겠습니다.

```{}
sliderInput("sdata1", "슬라이더 입력:", min=50, max=150, value=100)
```

위의 코드는 `sliderInput()`이라는 `*Input()` 패밀리 함수를 통해서 `input$sdata1`이라는 곳에 웹 데이터를 저장하는 것을 뜻합니다. `*Input()` 패밀리 함수는 같은 규칙을 가지는데 `입력형태명Input()`의 함수명을 가지고, 첫번째 인자는 `input$` 뒤로 붙을 컬럼명, 두번째 인자는 화면에 보여줄 글자를 의미합니다. 나머지 인자는 입력형태에 따라 다양하게 달라집니다. `shiny`에서 지원하는 입력형태는 [이곳][903]을 확인해 주세요.

---

## 실습 1

1. `runExample("01_hello")` 를 수정해보겠습니다.
    1. New File &gt; Shiny Web App ... &gt; Create 로 샤이니 파일을 만듭니다.
    1. sliderInput 을 Numeric input 형태로 바꿔주세요.
    1. bins의 최소값과 최대값을 입력하는 Slider range input을 추가해주세요.
    - server 코드 내에 hist 전 bins를 선언하는 곳에 min, max가 있습니다.

---

우선 서버쪽 부터 보겠습니다.
```{}
# shiny 패키지를 불러옵니다.
library(shiny)

# server를 function으로 선언합니다. 웹의 세계에서 사용할 변수는 input과 output 입니다.
function(input, output) {

# 웹의 세계의 변수인 output에 list 컬럼인 distPlot을 선언합니다.
# 그 선언을 renderPlot({})으로 해서 distPlot이 plot()으로 작성한 그림이라는 것을 이해합니다.
# renderPlot({ ... }) 함수 안에 R의 세계에서 hist() 함수의 결과가 나오게 작성합니다.
# 이때 input$bin으로 웹에서 사용자가 주는 데이터를 활용할 것입니다.
# bin은 경계라는 뜻으로 연속형 변수를 histogram을 그릴 때 얼마나 구간을 나눌 것인지를 결정합니다.
# ?hist를 통해 어떤 그림을 그리는 함수인지를 확인해 보세요.
# ?seq를 통해 어떤 결과물을 만드는 함수인지 확인해 보세요.

  output$distPlot &lt;- renderPlot({
    x    &lt;- faithful[, 2]  # Old Faithful Geyser data
    bins &lt;- seq(min(x), max(x), length.out = input$bins + 1)

    # draw the histogram with the specified number of bins
    hist(x, breaks = bins, col = 'darkgray', border = 'white')
  })

}
```
---
위에 코드에서 `input$bins`가 `render*({})` 함수 안에서 사용됬습니다. `output$`은 웹의 세계에서 사용하지만 `input$`은 `R`의 세계에서 사용합니다. 이부분은 `reactive({})` 함수에서 추가적으로 다루기로 하겠습니다. 이제 `ui`쪽 코드를 확인해 보겠습니다.

.center[![shiny-example-02](https://raw.githubusercontent.com/mrchypark/data_camp_dabrp/master/images/shiny-example-02.png)]

---

```{}
# shiny 패키지를 불러옵니다.
ibrary(shiny)

# fluidPage는 shiny의 페이지를 보여주는 핵심 기능입니다. 
# titlePanel, sidebarPanal, mainPanel로 구성되어 있습니다.
# titlePanel은 제목을 작성하는 곳입니다.
# sidebarPanel은 전체 화면을 3등분해서 왼쪽을 뜻합니다.
# mainPanel은 전체 화면을 3등분해서 오른쪽을 뜻합니다.
fluidPage(
  # Application title
  titlePanel("Hello Shiny!"),
  # Sidebar with a slider input for the number of bins
  sidebarLayout(
    sidebarPanel(
      sliderInput("bins",
                  "Number of bins:",
                  min = 1,
                  max = 50,
                  value = 30)
    ),

    # Show a plot of the generated distribution
    mainPanel(
      plotOutput("distPlot")
    )
  )
)
```

---

### input 및 output 설명

이제 코드를 다시 보면 `sliderInput`을 통해서 `input$bins` 데이터를 웹의 세상에서 받아오는 것을 볼 수있습니다. 지금 기본 값으로 `30`을 기록해 두었지만, 웹의 세상에서 변화시켜주는 것에 따라 `input$bins`의 데이터가 변해서 `server`에서 `input$bins`의 형태로 그 데이터를 사용할 수 있습니다.

&gt; 웹의 세상이나 R의 세상이란 말은 정확한 표현은 아니지만 이해를 돕기 위해서 활용했습니다.

그리고 `ui`에서는 웹의 세계로 나온 `output$distPlot`을 `plotOutput()` 함수로 웹 페이지에 위치시킬 수 있습니다. `output$distPlot`은 현재 `mainPanel`에 위치해 있네요. 위치의 세부적인 조정은 [이곳][905]을 참고하세요.

---
class: center, middle, title-slide

## 최소 동작 앱 만들기

---

## shiny의 최소 코드

```{}
library(shiny)

ui &lt;- fluidPage()
server &lt;- function(input, output){ }

shinyApp(ui=ui,server=server)
```


---

## ui 만들기

ui는 화면의 위치를 나누는 함수와 입력을 받는 요소, 출력을 보여주는 요소로 구성되어 있습니다. *는 여러 이름이 있다는 뜻입니다.


```r
  # *Page(), *Panel() 등의 함수로 위치를 나누고 모양을 결정
ui &lt;- fluidPage(
  # *Input() 함수로 입력을 받는 요소들을 배치
  # *Output() 함수로 결과물을 출력하여 배치
)
```

---

## 페이지 구조 만들기

fluidPage()는 반응형 페이지를 만든다는 뜻입니다. fluidRow() 함수, column() 함수와 함께 사용합니다.

```{}

fluidPage(
  
  fluidRow(
  
    column(),
    column()
    
  )

)


```

---

## column()

column() 은 총 화면 길이를 12개로 나누어서 사용합니다. 

```{}
fluidPage(
  fixedRow(
    column(2), column(10)
  )
)

```


![](https://shiny.rstudio.com/images/Shiny-Application-Layout-Guide-images/fluidGrid.png)

---

## offset 인자

offset 이란 그만큼 띄어낸다는 뜻입니다.

.pull-left[
```{}
fluidPage(
  fluidRow(
    column(4,
      "4"
    ),
    column(4, offset = 4,
      "4 offset 4"
    )      
  ),
  fluidRow(
    column(3, offset = 3,
      "3 offset 3"
    ),
    column(3, offset = 3,
      "3 offset 3"
    )  
  )
)
```
]
.pull-right[
![](https://shiny.rstudio.com/images/Shiny-Application-Layout-Guide-images/fluidOffsetting.png)
]

---

## column()내에 column() 사용

column()내에 column()을 추가할 수 있습니다. column()내에 column()은 다시 그 속한 column()을 통 12개로 나누어서 크기를 지정합니다. column()내에 column()을 지정하기 전에 column()을 fluidRow()로 감싸야 동작합니다. 

.pull-left[
```{}
fluidPage(
  fluidRow(
    column(12,
      "Fluid 12",
      fluidRow(
        column(6,
          "Fluid 6",
          fluidRow(
            column(6, 
              "Fluid 6"),
            column(6,
              "Fluid 6")
          )
        ),
        column(width = 6,
          "Fluid 6")
      )
    )
  )
)
```
]
.pull-right[
![](https://shiny.rstudio.com/images/Shiny-Application-Layout-Guide-images/fluidNesting.png)
]

---

## 어렵다면 *Panel() 사용

*Panel() 함수는 기본적으로 3가지(titlePanel(), sidebarPanel(), mainPanel())를 제공하며 구조는 아래와 같습니다. sidebarLayout() 은 sidebarPanel()의 위치(왼쪽이 기본, 오른쪽)를 지정하기 위해 감싸는 함수로 왼쪽으로 되어 있다면 필요하지 않습니다.

.pull-left[
```{}
fluidPage(
  titlePanel(),
  sidebarLayout(
    sidebarPanel(),
    mainPanel()
  )
)
```
]
.pull-right[
![](https://raw.githubusercontent.com/mrchypark/dabrp_classnote3/master/docs/img/panel.png)
]


---

[901]: http://shiny.rstudio.com/
[902]: http://shiny.rstudio.com/gallery/unicode-characters.html
[903]: http://shiny.rstudio.com/gallery/widget-gallery.html
[904]: https://github.com/rstudio/shiny-examples
[905]: http://shiny.rstudio.com/articles/layout-guide.html
[906]: http://bootstrapk.com/
[907]: http://shiny.rstudio.com/articles/html-tags.html
[908]: http://bootswatch.com/
[909]: http://leafletjs.com/
[910]: http://www.htmlwidgets.org/
[911]: https://rstudio.github.io/leaflet/
[912]: http://davidgohel.github.io/ggiraph/
[913]: http://datastorm-open.github.io/visNetwork/
[914]: https://rstudio.github.io/shinydashboard/
[915]: https://github.com/almasaeed2010/AdminLTE
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});
(function() {var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler"); if (!r) return; s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }"; d.head.appendChild(s);})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
